---
- name: Setup Raspberry Pi's for RetroPie install
  hosts: htpic

  tasks:
    - name: Disable overscan
      become: yes
      lineinfile:
        path: /boot/config.txt
        state: present
        regexp: 'disable_overscan'
        line: 'disable_overscan=1'

    - name: Enable hdmi force hotplug
      become: yes
      lineinfile:
        path: /boot/config.txt
        state: present
        regexp: 'hdmi_force_hotplug'
        line: 'hdmi_force_hotplug=1'

    - name: Set GPU memory to 128 MB
      become: yes
      lineinfile:
        path: /boot/config.txt
        state: present
        regexp: 'gpu_mem'
        line: 'gpu_mem=128'

    - name: Get the latest Docker convenience script
      become_user: pi
      get_url:
        url: https://get.docker.com
        dest: /home/pi/get-docker.sh
        mode: '0755'
        
    - name: Check if Docker binary exists
      become_user: pi
      stat:
        path: /usr/bin/docker
      register: docker_bin
          
    - name: Execute Docker convenience script
      become: yes
      shell: sh get-docker.sh
      args:
        chdir: /home/pi/
      when: docker_bin.stat.exists == False
        
    - name: Add pi to the docker group
      become: yes
      user:
        name: pi
        groups: docker
        append: yes
        state: present
        
    - name: Clean up the Docker convenience script
      become_user: pi
      file:
        path: /home/pi/get-docker.sh
        state: absent
        
    - name: Remove backports.ssl-match-hostname from pip
      become: yes
      pip:
        name: backports.ssl-match-hostname
        state: absent
        
    - name: Install python-backports.ssl-match-hostname apt package
      become: yes
      apt:
        name: python-backports.ssl-match-hostname
        state: present

    - name: Install docker via pip
      become: yes
      pip:
        name: docker
        state: present
...
