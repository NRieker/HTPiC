---
- name: Deploy containers on HTPiC host
  hosts: htpic

  tasks:
    - name: Create portainer volume
      become: yes
      file:
        path: /var/lib/docker/volumes/portainer/data
        state: directory
        mode: '0755'
    
    - name: Deploy portainer
      become_user: pi
      docker_container:
        name: portainer
        image: portainer/portainer
        state: started
        #recreate: yes
        restart_policy: always
        ports:
          - "9000:9000"
        volumes:
          - "/var/run/docker.sock:/var/run/docker.sock"
          - "/var/lib/docker/volumes/portainer/data:/data"
        env:
          TZ: "America/New_York"
          
    - name: Create heimdall volume
      become: yes
      file:
        path: /var/lib/docker/volumes/heimdall/config
        state: directory
        mode: '0755'
          
    - name: Deploy heimdall
      become_user: pi
      docker_container:
        name: heimdall
        hostname: heimdall
        image: linuxserver/heimdall
        #recreate: yes
        restart_policy: always
        ports:
          - "444:443"
          - "81:80"
        volumes:
          - "/var/lib/docker/volumes/heimdall/config:/config"
        env:
          TZ: "America/New_York"
          PUID: "1000"
          PGID: "1000"

    - name: Create plex volumes
      become: yes
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/docker/volumes/plex/config
        - /var/lib/docker/volumes/plex/transcode
        - /var/lib/docker/volumes/plex/media

    - name: Deploy plex
      become_user: pi
      docker_container:
        name: plex
        hostname: plex
        image: linuxserver/plex 
        restart_policy: always
        #recreate: yes
        network_mode: bridge
        volumes:
          - "/var/lib/docker/volumes/plex/config:/config"
          - "/var/lib/docker/volumes/plex/transcode:/transcode"
          - "/var/lib/docker/volumes/plex/media:/data"
          - "/media/pi/69E1-4ABE/Movies/:/movies"
        ports:
          - "32400:32400/tcp"
          - "3005:3005/tcp"
          - "8324:8324/tcp"
          - "32469:32469/tcp"
          - "1900:1900/udp"
          - "32410:32410/udp"
          - "32412:32412/udp"
          - "32413:32413/udp"
          - "32414:32414/udp"
        env:
          TZ: "America/New_York"
          HOSTNAME: "PlexServer"
          PUID: "1000"
          PGID: "1000"
          ALLOWED_NETWORKS: "192.168.1.0/24"
          ADVERTISE_IP: "http://192.168.1.73:32400"
...
